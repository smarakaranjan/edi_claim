from django.core.management.base import BaseCommand
from django.db import transaction

from superbill.models import EDIPayer, EDIElement, EDIPayerRule


class Command(BaseCommand):
    help = "Populate ALL 837P EDIPayerRules with CONSTANT values for format validation only"

    BASE_PAYER_NAME = "Default Payer"

    # (loop, segment, position) → CONSTANT VALUE
    # CONSTANTS = {
    #     # =========================
    #     # 1000A – SUBMITTER
    #     # =========================
    #     ("1000A", "NM1", 1): "41",
    #     ("1000A", "NM1", 2): "2",
    #     ("1000A", "NM1", 3): "TESTSUBMITTER",
    #     ("1000A", "NM1", 4): "JOHN",
    #     ("1000A", "NM1", 5): "M",
    #     ("1000A", "NM1", 6): "MR",
    #     ("1000A", "NM1", 7): "JR",
    #     ("1000A", "NM1", 8): "46",
    #     ("1000A", "NM1", 9): "123456",

    #     ("1000A", "PER", 1): "IC",
    #     ("1000A", "PER", 2): "JOHNDOE",
    #     ("1000A", "PER", 3): "TE",
    #     ("1000A", "PER", 4): "8005551212",
    #     ("1000A", "PER", 5): "FX",
    #     ("1000A", "PER", 6): "8005551213",

    #     # =========================
    #     # 1000B – RECEIVER
    #     # =========================
    #     ("1000B", "NM1", 1): "40",
    #     ("1000B", "NM1", 2): "2",
    #     ("1000B", "NM1", 3): "TESTPAYER",
    #     ("1000B", "NM1", 8): "46",
    #     ("1000B", "NM1", 9): "99999",

    #     # =========================
    #     # 2010AA – BILLING PROVIDER
    #     # =========================
    #     ("2010AA", "NM1", 1): "85",
    #     ("2010AA", "NM1", 2): "2",
    #     ("2010AA", "NM1", 3): "BILLINGPROVIDER",
    #     ("2010AA", "NM1", 4): "JOHN",
    #     ("2010AA", "NM1", 8): "XX",
    #     ("2010AA", "NM1", 9): "1234567893",

    #     ("2010AA", "N3", 1): "123 MAIN ST",
    #     ("2010AA", "N3", 2): "SUITE 100",

    #     ("2010AA", "N4", 1): "DALLAS",
    #     ("2010AA", "N4", 2): "TX",
    #     ("2010AA", "N4", 3): "75001",

    #     ("2010AA", "REF", 1): "EI",
    #     ("2010AA", "REF", 2): "987654321",

    #     ("2010AA", "PER", 1): "IC",
    #     ("2010AA", "PER", 2): "JANE DOE",
    #     ("2010AA", "PER", 3): "TE",
    #     ("2010AA", "PER", 4): "8005551212",
    #     ("2010AA", "PER", 5): "FX",
    #     ("2010AA", "PER", 6): "8005551213",

    #     # =========================
    #     # 2010AB – PAY-TO PROVIDER
    #     # =========================
    #     ("2010AB", "NM1", 1): "87",
    #     ("2010AB", "NM1", 2): "2",
    #     ("2010AB", "NM1", 3): "PAYTOPROVIDER",
    #     ("2010AB", "NM1", 4): "JANE",
    #     ("2010AB", "NM1", 8): "XX",
    #     ("2010AB", "NM1", 9): "1234567893",

    #     ("2010AB", "N3", 1): "456 SECOND ST",
    #     ("2010AB", "N3", 2): "SUITE 200",

    #     ("2010AB", "N4", 1): "AUSTIN",
    #     ("2010AB", "N4", 2): "TX",
    #     ("2010AB", "N4", 3): "73301",

    #     ("2010AB", "REF", 1): "EI",
    #     ("2010AB", "REF", 2): "123456789",

    #     # =========================
    #     # 2310 PROVIDERS
    #     # =========================
    #     ("2310A", "NM1", 1): "71",
    #     ("2310A", "NM1", 2): "1",
    #     ("2310A", "NM1", 3): "ATTENDING",
    #     ("2310A", "NM1", 4): "DOCTOR",
    #     ("2310A", "NM1", 8): "XX",
    #     ("2310A", "NM1", 9): "1234567890",

    #     ("2310B", "NM1", 1): "72",
    #     ("2310B", "NM1", 2): "1",
    #     ("2310B", "NM1", 3): "OPERATING",
    #     ("2310B", "NM1", 4): "DOCTOR",
    #     ("2310B", "NM1", 8): "XX",
    #     ("2310B", "NM1", 9): "1234567891",

    #     ("2310C", "NM1", 1): "73",
    #     ("2310C", "NM1", 2): "1",
    #     ("2310C", "NM1", 3): "OTHER",
    #     ("2310C", "NM1", 4): "DOCTOR",
    #     ("2310C", "NM1", 8): "XX",
    #     ("2310C", "NM1", 9): "1234567892",

    #     ("2310A", "N3", 1): "789 THIRD ST",
    #     ("2310A", "N3", 2): "FLOOR 3",
    #     ("2310A", "N4", 1): "HOUSTON",
    #     ("2310A", "N4", 2): "TX",
    #     ("2310A", "N4", 3): "77001",
    #     ("2310A", "REF", 1): "LU",
    #     ("2310A", "REF", 2): "111222",

    #     ("2310B", "N3", 1): "321 FOURTH ST",
    #     ("2310B", "N3", 2): "FLOOR 4",
    #     ("2310B", "N4", 1): "AUSTIN",
    #     ("2310B", "N4", 2): "TX",
    #     ("2310B", "N4", 3): "73301",
    #     ("2310B", "REF", 1): "LU",
    #     ("2310B", "REF", 2): "222333",

    #     ("2310C", "N3", 1): "654 FIFTH ST",
    #     ("2310C", "N3", 2): "FLOOR 5",
    #     ("2310C", "N4", 1): "DALLAS",
    #     ("2310C", "N4", 2): "TX",
    #     ("2310C", "N4", 3): "75001",
    #     ("2310C", "REF", 1): "LU",
    #     ("2310C", "REF", 2): "333444",

    #     # =========================
    #     # 2400 – SERVICE LINE
    #     # =========================
    #     ("2400", "LX", 1): "1",

    #     ("2400", "SV1", 1): "HC",
    #     ("2400", "SV1", 2): "99213",
    #     ("2400", "SV1", 3): "100",
    #     ("2400", "SV1", 4): "UN",
    #     ("2400", "SV1", 5): "1",
    #     ("2400", "SV1", 6): "1",
    #     ("2400", "SV1", 7): "0001",
    #     ("2400", "SV1", 8): "123456",

    #     ("2400", "REF", 1): "6R",
    #     ("2400", "REF", 2): "REF123",

    #     ("2400", "DTP", 1): "472",
    #     ("2400", "DTP", 2): "D8",
    #     ("2400", "DTP", 3): "20240101",

    #     ("2400", "HI", 1): "ABK",
    #     ("2400", "HI", 2): "J109",
    #     ("2400", "HI", 3): "A123",
    #     ("2400", "HI", 4): "B234",
    #     ("2400", "HI", 5): "C345",

    #     ("2400", "PWK", 1): "AP",
    #     ("2400", "PWK", 2): "T",
    #     ("2400", "PWK", 3): "ATT123",
    #     ("2400", "PWK", 4): "LAB REPORT",

    #     ("2400", "CN1", 1): "CT",
    #     ("2400", "CN1", 2): "100",
    #     ("2400", "CN1", 3): "0",
    #     ("2400", "CN1", 4): "CONTRACT123",

    #     ("2400", "SVD", 1): "PR",
    #     ("2400", "SVD", 2): "90",
    #     ("2400", "SVD", 3): "UN",
    #     ("2400", "SVD", 4): "1",
    #     ("2400", "SVD", 5): "0010",
    #     ("2400", "SVD", 6): "99213",

    #     ("2400", "CAS", 1): "CO",
    #     ("2400", "CAS", 2): "45",
    #     ("2400", "CAS", 3): "10",
    #     ("2400", "CAS", 4): "1",
    # }

    CONSTANTS = {
    # =========================
    # ISA – Interchange Control Header
    # =========================
    ("ISA", "ISA", 1): "00",
    ("ISA", "ISA", 2): "          ",
    ("ISA", "ISA", 3): "00",
    ("ISA", "ISA", 4): "          ",
    ("ISA", "ISA", 5): "ZZ",
    ("ISA", "ISA", 6): "SENDERID      ",
    ("ISA", "ISA", 7): "ZZ",
    ("ISA", "ISA", 8): "RECEIVERID    ",
    ("ISA", "ISA", 9): "260105",
    ("ISA", "ISA", 10): "1133",
    ("ISA", "ISA", 11): "U",
    ("ISA", "ISA", 12): "00501",
    ("ISA", "ISA", 13): "000000001",
    ("ISA", "ISA", 14): "0",
    ("ISA", "ISA", 15): "P",
    ("ISA", "ISA", 16): ":",

    # =========================
    # GS – Functional Group Header
    # =========================
    ("GS", "GS", 1): "HC",
    ("GS", "GS", 2): "SENDERID",
    ("GS", "GS", 3): "RECEIVERID",
    ("GS", "GS", 4): "20260105",
    ("GS", "GS", 5): "1133",
    ("GS", "GS", 6): "1",
    ("GS", "GS", 7): "X",
    ("GS", "GS", 8): "005010X222A1",

    # =========================
    # ST – Transaction Set Header
    # =========================
    ("ST", "ST", 1): "837",
    ("ST", "ST", 2): "0001",
    ("ST", "ST", 3): "005010X222A1",

    # =========================
    # BHT – Beginning Hierarchical Transaction
    # =========================
    ("BHT", "BHT", 1): "0019",
    ("BHT", "BHT", 2): "00",
    ("BHT", "BHT", 3): "0001",
    ("BHT", "BHT", 4): "20260105",
    ("BHT", "BHT", 5): "1133",
    ("BHT", "BHT", 6): "CH",

    # =========================
    # 1000A – Submitter
    # =========================
    ("1000A", "NM1", 1): "41",
    ("1000A", "NM1", 2): "2",
    ("1000A", "NM1", 3): "TESTSUBMITTER",
    ("1000A", "NM1", 4): "",
    ("1000A", "NM1", 5): "",
    ("1000A", "NM1", 6): "",
    ("1000A", "NM1", 7): "",
    ("1000A", "NM1", 8): "46",
    ("1000A", "NM1", 9): "123456",

    ("1000A", "PER", 1): "IC",
    ("1000A", "PER", 2): "JOHNDOE",
    ("1000A", "PER", 3): "TE",
    ("1000A", "PER", 4): "8005551212",
    ("1000A", "PER", 5): "",
    ("1000A", "PER", 6): "",
    ("1000A", "PER", 7): "",

    # =========================
    # 1000B – Receiver
    # =========================
    ("1000B", "NM1", 1): "40",
    ("1000B", "NM1", 2): "2",
    ("1000B", "NM1", 3): "TESTPAYER",
    ("1000B", "NM1", 4): "",
    ("1000B", "NM1", 5): "",
    ("1000B", "NM1", 6): "",
    ("1000B", "NM1", 7): "",
    ("1000B", "NM1", 8): "46",
    ("1000B", "NM1", 9): "99999",

    # =========================
    # 2010AA – Billing Provider
    # =========================
    ("2010AA", "NM1", 1): "85",
    ("2010AA", "NM1", 2): "2",
    ("2010AA", "NM1", 3): "BILLINGPROVIDER",
    ("2010AA", "NM1", 4): "",
    ("2010AA", "NM1", 5): "",
    ("2010AA", "NM1", 6): "",
    ("2010AA", "NM1", 7): "",
    ("2010AA", "NM1", 8): "XX",
    ("2010AA", "NM1", 9): "1234567893",

    ("2010AA", "N3", 1): "123 MAIN ST",
    ("2010AA", "N4", 1): "DALLAS",
    ("2010AA", "N4", 2): "TX",
    ("2010AA", "N4", 3): "75001",
    ("2010AA", "REF", 1): "EI",
    ("2010AA", "REF", 2): "987654321",

    # =========================
    # 2010AB – Pay-to Provider
    # =========================
    ("2010AB", "NM1", 1): "87",
    ("2010AB", "NM1", 2): "2",
    ("2010AB", "NM1", 3): "PAYTOPROVIDER",
    ("2010AB", "NM1", 4): "",
    ("2010AB", "NM1", 5): "",
    ("2010AB", "NM1", 6): "",
    ("2010AB", "NM1", 7): "",
    ("2010AB", "NM1", 8): "XX",
    ("2010AB", "NM1", 9): "1234567893",

    # =========================
    # 2310 Providers
    # =========================
    ("2310A", "NM1", 1): "71",
    ("2310A", "NM1", 2): "1",
    ("2310A", "NM1", 3): "ATTENDING",
    ("2310A", "NM1", 4): "DOCTOR",
    ("2310A", "NM1", 5): "",
    ("2310A", "NM1", 6): "",
    ("2310A", "NM1", 7): "",
    ("2310A", "NM1", 8): "XX",
    ("2310A", "NM1", 9): "1234567890",

    ("2310B", "NM1", 1): "72",
    ("2310B", "NM1", 2): "1",
    ("2310B", "NM1", 3): "OPERATING",
    ("2310B", "NM1", 4): "DOCTOR",
    ("2310B", "NM1", 5): "",
    ("2310B", "NM1", 6): "",
    ("2310B", "NM1", 7): "",
    ("2310B", "NM1", 8): "XX",
    ("2310B", "NM1", 9): "1234567891",

    ("2310C", "NM1", 1): "73",
    ("2310C", "NM1", 2): "1",
    ("2310C", "NM1", 3): "OTHER",
    ("2310C", "NM1", 4): "DOCTOR",
    ("2310C", "NM1", 5): "",
    ("2310C", "NM1", 6): "",
    ("2310C", "NM1", 7): "",
    ("2310C", "NM1", 8): "XX",
    ("2310C", "NM1", 9): "1234567892",

    # =========================
    # 2400 – Service Line
    # =========================
    ("2400", "LX", 1): "1",
    ("2400", "SV1", 1): "HC",
    ("2400", "SV1", 2): "99213",
    ("2400", "SV1", 3): "100",
    ("2400", "SV1", 4): "UN",
    ("2400", "SV1", 5): "1",
    ("2400", "DTP", 1): "472",
    ("2400", "DTP", 2): "D8",
    ("2400", "DTP", 3): "20240101",
    ("2400", "HI", 1): "ABK",
    ("2400", "HI", 2): "J109",

    # =========================
    # IEA – Interchange Control Trailer
    # =========================
    ("IEA", "IEA", 1): "1",
    ("IEA", "IEA", 2): "1",

    # =========================
    # GE – Functional Group Trailer
    # =========================
    ("GE", "GE", 1): "1",
    ("GE", "GE", 2): "1",
}



    @transaction.atomic
    def handle(self, *args, **options):
        payer, _ = EDIPayer.objects.get_or_create(
            name=self.BASE_PAYER_NAME,
            defaults={
                "transaction_set": "837P",
                "version": "005010X222A1",
            },
        )

        self.stdout.write(self.style.SUCCESS(f"Using payer: {payer.name}"))

        created, skipped = 0, 0

        for element in EDIElement.objects.select_related("segment"):
            seg = element.segment
            loop = getattr(seg, "loop_code", None)
            key = (loop, seg.name, element.position)

            value = self.CONSTANTS.get(key, "X")

            _, was_created = EDIPayerRule.objects.get_or_create(
                payer=payer,
                element=element,
                defaults={
                    "rule_type": EDIPayerRule.EDIRuleType.CONSTANT,
                    "constant_value": value,
                    "min_length": None,
                    "max_length": element.length,
                    "pad_char": " ",          # default padding char
                    "pad_side": "right",      # cannot be null
                    "required": True,
                    "order": 0,
                },
            )

            created += int(was_created)
            skipped += int(not was_created)

        self.stdout.write(self.style.SUCCESS(
            f"FORMAT-ONLY rules populated | created={created}, skipped={skipped}"
        ))
